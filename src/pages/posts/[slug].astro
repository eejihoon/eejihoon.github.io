---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts
    .filter((post) => post.data.draft !== true && post.body.trim().length > 0)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

const { post } = Astro.props as { post: CollectionEntry<"posts"> };
const { Content, headings } = await post.render();
const tocHeadings = headings.filter((heading) => heading.depth === 2 || heading.depth === 3);
const postTitle = post.data.title ?? post.slug;

function formatDate(date: Date): string {
  return date.toISOString().split("T")[0];
}
---

<BaseLayout title={`${postTitle} | --verbose`}>
  <h1>{postTitle}</h1>
  {
    post.data.date && (
      <time datetime={post.data.date.toISOString()}>{formatDate(post.data.date)}</time>
    )
  }

  {
    tocHeadings.length > 0 && (
      <nav class="toc" aria-label="Table of contents">
        <strong>목차</strong>
        <ul>
          {
            tocHeadings.map((heading) => (
              <li style={`margin-left:${heading.depth - 2}em`}>
                <a href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            ))
          }
        </ul>
      </nav>
    )
  }

  <article>
    <Content />
  </article>
</BaseLayout>
